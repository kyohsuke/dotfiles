#!/usr/bin/env ruby

exit EXIT_FAILURE if ARGV.empty?

require 'fileutils'

VERSION = -'v0.11.0'

URL = ARGV.shift
urls = URL.split('/')

TIME = urls[-1]
ID = urls[-2]
FILE_AAC = -"#{TIME}-#{ID}.aac"
FILE_M4A = -"#{TIME}-#{ID}.m4a"

puts "ID      : #{ID}"
puts "TIME    : #{TIME}"
puts "FILE_AAC: #{FILE_AAC}"
puts "FILE_M4A: #{FILE_M4A}"

cmd = "docker run --rm -v \"#{ENV['PWD']}\":/output:delegated yyoshiki41/radigo:#{VERSION} rec -id=#{ID} -s=#{TIME}"
puts cmd
system(cmd)

cmd = "ffmpeg -i #{FILE_AAC} -c copy '#{FILE_M4A}'"
puts cmd
system(cmd)

FileUtils.rm(FILE_AAC)
